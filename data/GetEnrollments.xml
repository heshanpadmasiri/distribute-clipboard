<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GetEnrollments" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
	<property name="hadError" scope="default" type="STRING" value="false" />
	<property name="had500" scope="default" type="STRING" value="false" />
	<property name="had401" scope="default" type="STRING" value="false" />
	<property name="had404" scope="default" type="STRING" value="false" />
	<property name="had400" scope="default" type="STRING" value="false" />
	<header value="gzip" name="Accept-Encoding" scope="transport" />
	<iterate continueParent="true" expression="$body">
		<target>
			<sequence>
				<property name="courseId" expression="json-eval($.course_id)"/>
				<property
					expression="fn:concat($ctx:protocol, '://', $ctx:canvasHost, ':', $ctx:canvasPort, '/api/v1/courses/',
					$ctx:courseId, '/enrollments?per_page=', $ctx:perPage, '&amp;type=', $ctx:enrollmentType,
					'&amp;page=1&amp;state=active')"
				name="uri.var.enrollments" scope="default" type="STRING" />
				<header expression="$ctx:canvasToken" name="Authorization" scope="transport" />
				<log>
					<property name="message" value="Before get enrollments" />
					<property expression="$ctx:uri.var.enrollments" name="url" />
				</log>
				<call>
					<endpoint key="GetEnrollmentsEndpoint" />
					<target type="body" />
				</call>
				<log>
					<property name="message" value="after get enrollments" />
					<property expression="$body" name="response" />
					<property expression="$axis2:HTTP_SC" name="status" />
				</log>
				<filter regex="200" source="$axis2:HTTP_SC">
					<then />
					<else>
						<property name="hadError" scope="default" type="STRING" value="true" />
						<log category="ERROR" level="full">
							<property name="message" value="Get enrollments failed." />
							<property expression="$body" name="response" />
							<property expression="$axis2:HTTP_SC" name="status" />
							<property expression="$ctx:ERROR_MESSAGE" name="ERROR_MESSAGE" />
						</log>
						<switch source="$axis2:HTTP_SC">
							<case regex="500">
								<property name="had500" scope="default" type="STRING" value="true" />
							</case>
							<case regex="401">
								<property name="had401" scope="default" type="STRING" value="true" />
							</case>
							<case regex="404">
								<property name="had404" scope="default" type="STRING" value="true" />
							</case>
							<default />
						</switch>
					</else>
				</filter>
			</sequence>
		</target>
	</iterate>
	<aggregate>
		<completeCondition>
			<messageCount max="-1" min="-1" />
		</completeCondition>
		<onComplete aggregateElementType="root" expression="$body" />
	</aggregate>
	<log>
		<property name="message" value="after aggregate" />
		<property expression="$body" name="response" />
		<property expression="$axis2:HTTP_SC" name="status" />
	</log>
	<filter source="$ctx:hadError" regex="true">
		<then>
			<filter source="$ctx:had500" regex="true">
				<then>
					<call-template target="RespondWithError">
						<with-param name="status" value="500" />
						<with-param name="message" value="Canvas API Internal Server Error" />
					</call-template>
				</then>
				<else>
					<filter source="$ctx:had401" regex="true">
						<then>
							<call-template target="RespondWithError">
								<with-param name="status" value="401" />
								<with-param name="message" value="Canvas API Unauthorized" />
							</call-template>
						</then>
						<else>
							<filter source="$ctx:had404" regex="true">
								<then>
									<call-template target="RespondWithError">
										<with-param name="status" value="404" />
										<with-param name="message"
											value="Enrollments not found for courseCode= {$ctx:courseCode} in Canvas" />
									</call-template>
								</then>
								<else>
									<call-template target="RespondWithError">
										<with-param name="status" value="500" />
										<with-param name="message" value="Canvas API unknown error" />
									</call-template>
								</else>
							</filter>
						</else>
					</filter>
				</else>
			</filter>
		</then>
		<else>
			<log level="simple">
				<property name="message" value="Finish get enrollments" />
				<property expression="$body" name="response" />
			</log>
		</else>
	</filter>
</sequence>
